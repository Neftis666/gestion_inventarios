{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ğŸ“Š Panel Principal</h2>
  <p class="text-muted">Resumen general de la plataforma</p>

  <!-- Tarjetas de resumen -->
  <div class="row text-center mt-4">
    <div class="col-md-3">
      <div class="card shadow-sm p-3 border-primary">
        <h4>ğŸ‘¤ Usuarios</h4>
        <h2 class="text-primary">{{ total_users }}</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm p-3 border-info">
        <h4>ğŸ§¾ Compras</h4>
        <h2 class="text-info">{{ total_compras }}</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm p-3 border-success">
        <h4>ğŸ’² Ventas</h4>
        <h2 class="text-success">{{ total_ventas }}</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm p-3 border-warning">
        <h4>ğŸ“¦ Productos</h4>
        <h2 class="text-warning">{{ total_productos }}</h2>
      </div>
    </div>
  </div>

  <!-- Alertas -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">âš ï¸ Alertas</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% if stock_critico > 0 %}
            <li class="list-group-item list-group-item-danger">
              <strong>{{ stock_critico }}</strong> productos con stock crÃ­tico
              <a href="{{ url_for('inventario.listar_inventario') }}" class="float-end btn btn-sm btn-danger">Ver</a>
            </li>
            {% endif %}
            {% if ordenes_pendientes > 0 %}
            <li class="list-group-item list-group-item-warning">
              <strong>{{ ordenes_pendientes }}</strong> Ã³rdenes pendientes de aprobar
              <a href="{{ url_for('ordenes.listar_ordenes') }}" class="float-end btn btn-sm btn-warning">Ver</a>
            </li>
            {% endif %}
            {% if stock_critico == 0 and ordenes_pendientes == 0 %}
            <li class="list-group-item list-group-item-success">
              âœ… No hay alertas pendientes
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Accesos rÃ¡pidos -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸš€ Accesos RÃ¡pidos</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{{ url_for('compras.nueva_compra') }}" class="btn btn-primary">ğŸ§¾ Nueva Compra</a>
            <a href="{{ url_for('ventas.nueva_venta') }}" class="btn btn-success">ğŸ’² Nueva Venta</a>
            <a href="{{ url_for('inventario.nuevo_producto') }}" class="btn btn-warning">ğŸ“¦ Nuevo Producto</a>
            <a href="{{ url_for('ordenes.nueva_orden') }}" class="btn btn-info">ğŸ“‘ Nueva Orden</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GRÃFICAS -->
  <div class="row mt-5">

    <!-- Ventas vs Compras -->
    <div class="col-md-12">
      <div class="card shadow-sm p-3 mb-4">
        <h4 class="text-center">ğŸ“ˆ Ventas vs Compras</h4>
        <canvas id="ventasComprasChart" height="120"></canvas>
      </div>
    </div>

    <!-- Cumplimiento de Meta -->
    <div class="col-md-6">
      <div class="card shadow-sm p-3 mb-4 text-center">
        <h4>ğŸ¯ Cumplimiento de Meta</h4>
        <canvas id="metaChart" height="300"></canvas>
        <p class="mt-2"><strong>Meta:</strong> ${{ meta if meta else 0 }}</p>
        <p><strong>Ventas acumuladas:</strong> ${{ suma_ventas }}</p>
        <p><strong>Faltante:</strong> ${{ (meta - suma_ventas) if meta else 0 }}</p>
      </div>
    </div>

    <!-- Utilidad -->
    <div class="col-md-6">
      <div class="card shadow-sm p-3 mb-4 text-center">
        <h4>ğŸ’° Utilidad del PerÃ­odo</h4>
        <canvas id="utilidadChart" height="300"></canvas>
      </div>
    </div>

  </div>
</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* -------------------- 1. Ventas vs Compras -------------------- */
const ventasComprasChart = new Chart(document.getElementById('ventasComprasChart'), {
  type: 'bar',
  data: {
    labels: {{ meses | tojson }},
    datasets: [
      {
        label: 'Ventas',
        data: {{ ventas_por_mes | tojson }},
        borderWidth: 2,
        backgroundColor: 'rgba(0, 200, 0, 0.4)',
        borderColor: 'green'
      },
      {
        label: 'Compras',
        data: {{ compras_por_mes | tojson }},
        borderWidth: 2,
        backgroundColor: 'rgba(255, 0, 0, 0.4)',
        borderColor: 'red'
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { tooltip: { enabled: true } }
  }
});

/* -------------------- 2. Cumplimiento de Meta -------------------- */
const meta = {{ meta if meta else 0 }};
const ventasAcum = {{ suma_ventas }};
const porcentaje = meta > 0 ? (ventasAcum / meta) * 100 : 0;

let colorMeta = "red";
if (porcentaje >= 90) colorMeta = "green";
else if (porcentaje >= 70) colorMeta = "yellow";

const metaChart = new Chart(document.getElementById('metaChart'), {
  type: 'doughnut',
  data: {
    labels: ["Cumplido", "Faltante"],
    datasets: [{
      data: [porcentaje, 100 - porcentaje],
      backgroundColor: [colorMeta, "lightgray"]
    }]
  },
  options: { responsive: true }
});

/* -------------------- 3. Utilidad -------------------- */
const utilidadChart = new Chart(document.getElementById('utilidadChart'), {
  type: 'bar',
  data: {
    labels: ["Ingresos", "Costos", "Utilidad"],
    datasets: [{
      data: [
        {{ suma_ventas }},
        {{ suma_compras }},
        {{ margen }}
      ],
      backgroundColor: [
        "green",
        "red",
        "{{ 'green' if margen >= 0 else 'red' }}"
      ]
    }]
  },
  options: { responsive: true }
});
</script>

{% endblock %}
