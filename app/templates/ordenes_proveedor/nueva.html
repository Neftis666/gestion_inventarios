{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>‚ûï Nueva Orden de Proveedor</h2>
      <p class="text-muted">Crear una nueva orden</p>
    </div>
    <a href="{{ url_for('ordenes_proveedor.listar_ordenes') }}" class="btn btn-secondary">‚Üê Volver</a>
  </div>

  <form method="POST" action="{{ url_for('ordenes_proveedor.nueva_orden') }}">
    <div class="row g-4">

      <!-- Datos del proveedor -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üè¢ Datos del Proveedor</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">

              <!-- Selector de proveedor -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Seleccionar Proveedor de la Lista</label>
                <select name="proveedor_id" id="proveedor_id" class="form-select" onchange="autocompletarProveedor(this)">
                  <option value="0">-- Escribir manualmente --</option>
                  {% for p in proveedores %}
                  <option value="{{ p.id }}"
                    data-nombre="{{ p.nombre }}"
                    data-direccion="{{ p.direccion or '' }}"
                    data-telefono="{{ p.telefono or '' }}">
                    {{ p.nombre }} {% if p.nit %}({{ p.nit }}){% endif %}
                  </option>
                  {% endfor %}
                </select>
                <small class="text-muted">O deja en "Escribir manualmente" para ingresar uno nuevo</small>
              </div>

              <!-- Proveedor manual -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Nombre del Proveedor <span class="text-danger">*</span></label>
                <input type="text" name="proveedor_manual" id="proveedor_manual" class="form-control" placeholder="Nombre del proveedor" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Direcci√≥n</label>
                <input type="text" name="direccion_proveedor" id="direccion_proveedor" class="form-control" placeholder="Direcci√≥n del proveedor">
              </div>

              <div class="col-md-3">
                <label class="form-label">Tel√©fono</label>
                <input type="text" name="telefono_proveedor" id="telefono_proveedor" class="form-control" placeholder="Tel√©fono">
              </div>

              <div class="col-md-3">
                <label class="form-label">Fecha de Emisi√≥n</label>
                <input type="date" name="fecha_emision" class="form-control" value="{{ today }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">N¬∞ Orden Cliente</label>
                <input type="text" name="numero_orden_cliente" class="form-control" placeholder="N√∫mero de referencia del cliente">
              </div>

              <div class="col-md-6">
                <label class="form-label">Sucursal / Destino</label>
                <input type="text" name="sucursal_cliente" class="form-control" placeholder="Sucursal o destino de entrega">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üì¶ Productos / √çtems</h5>
            <button type="button" class="btn btn-light btn-sm" onclick="agregarFila()">‚ûï Agregar √çtem</button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0" id="tablaProductos">
                <thead class="table-dark">
                  <tr>
                    <th style="width:40%">Descripci√≥n</th>
                    <th style="width:10%">Cantidad</th>
                    <th style="width:10%">Unidad</th>
                    <th style="width:15%">Precio Unit.</th>
                    <th style="width:15%">Subtotal</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="filasProductos">
                  <tr>
                    <td><input type="text" name="producto[]" class="form-control form-control-sm" placeholder="Descripci√≥n del producto" required></td>
                    <td><input type="number" name="cantidad[]" class="form-control form-control-sm cantidad" min="1" value="1" onchange="calcularFila(this)" required></td>
                    <td>
                      <select name="unidad[]" class="form-select form-select-sm">
                        <option>UND</option><option>KG</option><option>LT</option>
                        <option>MT</option><option>CJ</option><option>BLS</option>
                      </select>
                    </td>
                    <td><input type="number" name="precio[]" class="form-control form-control-sm precio" step="0.01" min="0" value="0" onchange="calcularFila(this)" required></td>
                    <td><input type="text" class="form-control form-control-sm subtotal-fila bg-light" readonly value="$0.00"></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">üóëÔ∏è</button></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Totales y observaciones -->
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-light">
            <h6 class="mb-0">üìù Observaciones</h6>
          </div>
          <div class="card-body">
            <textarea name="observaciones" class="form-control" rows="5" placeholder="Notas adicionales..."></textarea>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h6 class="mb-0">üí∞ Resumen de Totales</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">IVA (%)</label>
                <input type="number" name="iva" id="iva" class="form-control" value="19" min="0" max="100" onchange="calcularTotales()">
              </div>
              <div class="col-6">
                <label class="form-label">Descuento ($)</label>
                <input type="number" name="descuento" id="descuento" class="form-control" value="0" min="0" onchange="calcularTotales()">
              </div>
            </div>
            <hr>
            <table class="table table-sm mb-0">
              <tr>
                <td>Subtotal:</td>
                <td class="text-end fw-bold" id="resumen-subtotal">$0.00</td>
              </tr>
              <tr>
                <td>IVA:</td>
                <td class="text-end" id="resumen-iva">$0.00</td>
              </tr>
              <tr>
                <td>Descuento:</td>
                <td class="text-end text-danger" id="resumen-descuento">-$0.00</td>
              </tr>
              <tr class="table-success">
                <td><strong>TOTAL:</strong></td>
                <td class="text-end"><strong id="resumen-total">$0.00</strong></td>
              </tr>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="d-flex justify-content-end mt-4 gap-2">
      <a href="{{ url_for('ordenes_proveedor.listar_ordenes') }}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success btn-lg">üíæ Crear Orden</button>
    </div>
  </form>
</div>

<script>
// Autocompletar campos cuando se selecciona un proveedor de la lista
function autocompletarProveedor(select) {
  const option = select.options[select.selectedIndex];
  if (option.value !== '0') {
    document.getElementById('proveedor_manual').value = option.dataset.nombre || '';
    document.getElementById('direccion_proveedor').value = option.dataset.direccion || '';
    document.getElementById('telefono_proveedor').value = option.dataset.telefono || '';
  } else {
    document.getElementById('proveedor_manual').value = '';
    document.getElementById('direccion_proveedor').value = '';
    document.getElementById('telefono_proveedor').value = '';
  }
}

// Calcular subtotal de cada fila
function calcularFila(input) {
  const fila = input.closest('tr');
  const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
  const precio = parseFloat(fila.querySelector('.precio').value) || 0;
  const subtotal = cantidad * precio;
  fila.querySelector('.subtotal-fila').value = '$' + subtotal.toLocaleString('es-CO', {minimumFractionDigits: 2});
  calcularTotales();
}

// Calcular totales generales
function calcularTotales() {
  let subtotal = 0;
  document.querySelectorAll('#filasProductos tr').forEach(fila => {
    const cantidad = parseFloat(fila.querySelector('.cantidad')?.value) || 0;
    const precio = parseFloat(fila.querySelector('.precio')?.value) || 0;
    subtotal += cantidad * precio;
  });

  const ivaPct = parseFloat(document.getElementById('iva').value) || 0;
  const descuento = parseFloat(document.getElementById('descuento').value) || 0;
  const iva = subtotal * (ivaPct / 100);
  const total = subtotal + iva - descuento;

  document.getElementById('resumen-subtotal').textContent = '$' + subtotal.toLocaleString('es-CO', {minimumFractionDigits: 2});
  document.getElementById('resumen-iva').textContent = '$' + iva.toLocaleString('es-CO', {minimumFractionDigits: 2});
  document.getElementById('resumen-descuento').textContent = '-$' + descuento.toLocaleString('es-CO', {minimumFractionDigits: 2});
  document.getElementById('resumen-total').textContent = '$' + total.toLocaleString('es-CO', {minimumFractionDigits: 2});
}

// Agregar nueva fila
function agregarFila() {
  const tbody = document.getElementById('filasProductos');
  const fila = document.createElement('tr');
  fila.innerHTML = `
    <td><input type="text" name="producto[]" class="form-control form-control-sm" placeholder="Descripci√≥n del producto" required></td>
    <td><input type="number" name="cantidad[]" class="form-control form-control-sm cantidad" min="1" value="1" onchange="calcularFila(this)" required></td>
    <td>
      <select name="unidad[]" class="form-select form-select-sm">
        <option>UND</option><option>KG</option><option>LT</option>
        <option>MT</option><option>CJ</option><option>BLS</option>
      </select>
    </td>
    <td><input type="number" name="precio[]" class="form-control form-control-sm precio" step="0.01" min="0" value="0" onchange="calcularFila(this)" required></td>
    <td><input type="text" class="form-control form-control-sm subtotal-fila bg-light" readonly value="$0.00"></td>
    <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(fila);
}

// Eliminar fila
function eliminarFila(btn) {
  const filas = document.querySelectorAll('#filasProductos tr');
  if (filas.length > 1) {
    btn.closest('tr').remove();
    calcularTotales();
  } else {
    alert('Debe haber al menos un producto.');
  }
}
</script>
{% endblock %}
